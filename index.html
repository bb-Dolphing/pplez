<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>간편 설정 및 잠금 수업 일정표</title>
    <style>
        /* 기본 스타일 */
        body { font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif; margin: 20px; background-color: #f8f8f8; }
        .schedule-container { max-width: 750px; margin: 0 auto; background-color: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-radius: 10px; overflow: hidden; }
        h2 { text-align: center; color: #2c3e50; padding: 20px 0; margin: 0; border-bottom: 2px solid #eee; }
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .schedule-table th, .schedule-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
        .schedule-table th { background-color: #ecf0f1; color: #34495e; font-weight: bold; position: sticky; top: 0; z-index: 10; cursor: default; }
        
        /* 회차, 요일 셀 (배경 있는 셀) */
        .schedule-table td:first-child, .schedule-table td:nth-child(3) { 
            background-color: #f0f4f7;
            font-weight: bold; 
            cursor: default; 
            color: #555;
        }
        
        /* 주말 색상 강조 */
        .day-0 { color: #e74c3c !important; font-weight: bold; } /* 일요일: 빨간색 */
        .day-6 { color: #3498db !important; font-weight: bold; } /* 토요일: 파란색 */

        /* 날짜/시간 셀의 주말 색상 (editable-content) */
        td.editable-content.day-0 { color: #e74c3c !important; }
        td.editable-content.day-6 { color: #3498db !important; }


        .schedule-table tbody tr:nth-child(even):not(.month-header) { background-color: #f9f9f9; }
        .editable-content { cursor: pointer; }
        .editable-cell input { width: 90%; padding: 5px; box-sizing: border-box; border: 1px solid #3498db; border-radius: 4px; text-align: inherit; }
        .date-input-field input[type="date"] { width: 130px; min-height: 20px; }

        /* 설정 패널 스타일 */
        .setting-panel {
            padding: 20px;
            background-color: #e0f7fa;
            border-bottom: 2px solid #00bcd4;
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { font-weight: bold; color: #00796b; display: block; margin-bottom: 5px; }
        .input-group input[type="number"], .input-group input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(50% - 10px);
            box-sizing: border-box;
        }

        /* 요일 선택 */
        .day-selection-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .day-selection-group label {
            background-color: #fff;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: normal;
        }
        .day-selection-group input[type="checkbox"] { display: none; }
        .day-selection-group input[type="checkbox"]:checked + label {
            background-color: #00bcd4;
            color: white;
            border-color: #0097a7;
        }

        /* 요일별 시간 컨테이너 */
        #day-time-inputs {
            padding: 10px;
            border: 1px solid #b2ebf2;
            background-color: #ffffff;
            border-radius: 4px;
        }
        #day-time-inputs .time-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        #day-time-inputs .time-input-row label {
            font-weight: normal;
            min-width: 70px;
            color: #333;
        }
        #day-time-inputs .time-input-row .time-fields {
            display: flex;
            gap: 10px;
            flex-grow: 1;
        }
        #day-time-inputs .time-input-row .time-fields input[type="time"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            max-width: 120px;
            flex-grow: 1;
        }
        
        /* 버튼 그룹 스타일 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        .setting-panel button {
            padding: 10px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #generate-schedule {
            flex-grow: 1;
            background-color: #00bcd4;
            color: white;
        }
        #generate-schedule:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #lock-toggle {
            width: 120px;
            background-color: #f39c12;
            color: white;
        }
        #lock-toggle.unlocked {
             background-color: #2ecc71;
        }

        /* 정보 아이콘 및 툴팁 스타일 */
        .info-tooltip-container {
            position: relative; 
            display: flex;
            align-items: center;
        }

        .info-icon {
            font-size: 1.2em;
            font-weight: bold;
            color: #3498db;
            cursor: pointer;
            border: 1px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
            display: inline-block;
            user-select: none;
            margin-right: 5px;
        }

        .info-tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 9999; 
            bottom: 145%;
            left: 50%;
            margin-left: -140px; 
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.85em;
            line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .info-tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .info-tooltip-text.visible {
            visibility: visible;
            opacity: 1;
        }

        #guide { text-align: left; margin-bottom: 10px; font-size: 0.9em; color: #34495e; padding-left: 10px; border-left: 3px solid #f39c12; padding: 5px 0 5px 10px; margin-left: 10px; }
    </style>
</head>
<body>

<div class="schedule-container">
    <h2>간편 설정 수업 일정표</h2>

    <div class="setting-panel">
        <div class="input-group">
            <label for="total-classes">총 회차 수 / 수업 시작일</label>
            <input type="number" id="total-classes" value="35" min="1" max="100" style="margin-right: 10px;">
            <input type="date" id="start-date">
        </div>

        <div class="input-group">
            <label>수업 요일 선택</label>
            <div class="day-selection-group" id="day-selection-group">
                <input type="checkbox" id="day-0" value="0"><label for="day-0">일</label>
                <input type="checkbox" id="day-1" value="1"><label for="day-1">월</label>
                <input type="checkbox" id="day-2" value="2"><label for="day-2">화</label>
                <input type="checkbox" id="day-3" value="3" checked><label for="day-3">수</label>
                <input type="checkbox" id="day-4" value="4"><label for="day-4">목</label>
                <input type="checkbox" id="day-5" value="5"><label for="day-5">금</label>
                <input type="checkbox" id="day-6" value="6"><label for="day-6">토</label>
            </div>
        </div>

        <div class="input-group">
            <label>요일별 수업 시간 (시작 시간 - 종료 시간, **10분 단위**)</label>
            <div id="day-time-inputs">
                </div>
        </div>
        
        <div class="button-group">
            <div class="info-tooltip-container">
                <span id="lock-info-icon" class="info-icon" onclick="toggleTooltip(event)">ⓘ</span>
                <div id="lock-info-tooltip" class="info-tooltip-text">
                    * **일정 잠금/해제 기능 안내** *<br>
                    테이블 내용을 실수로 덮어쓰지 않도록 **잠금 상태**가 기본입니다.<br><br>
                    [🔒 잠금 해제]를 누르면 일정을 새로 만들거나 변경할 수 있습니다.
                </div>
            </div>
            
            <button id="lock-toggle" onclick="toggleLock()">🔒 잠금 해제</button>
            <button id="generate-schedule" onclick="generateSchedule()" disabled>일정 생성/업데이트</button>
        </div>
    </div>
    
    <hr style="margin: 0; border-color: #eee;">

    <div style="padding: 10px 0;">
        <div id="guide">
            - **[생성/업데이트] 버튼은 잠금 해제 후 사용 가능합니다.** <span style="font-weight: bold; color: #e74c3c;">(실수 방지)</span><br>
            - **날짜를 수정**하면 요일은 자동 반영됩니다. <span style="color: #3498db;">(날짜: YYYY.MM.DD 형식)</span><br>
            - **토요일은 파란색, 일요일은 빨간색**으로 표시됩니다.<br>
            - **DELETE 키**를 누르면 해당 회차가 **영구 삭제**됩니다.
        </div>
    </div>

    <div class="table-wrap">
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>회차</th>
                    <th class="editable-header">날짜</th>
                    <th>요일</th>
                    <th class="editable-header">시간</th>
                </tr>
            </thead>
            <tbody id="schedule-body">
                <tr class="month-header"><td colspan="4">👆 정보를 입력하고 잠금 해제 후 [일정 생성/업데이트]를 눌러주세요.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const tableBody = document.getElementById('schedule-body');
    let currentEditingCell = null;
    const currentYear = new Date().getFullYear();
    const dayNamesKo = ['일', '월', '화', '수', '목', '금', '토'];

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('start-date').value = `${yyyy}-${mm}-${dd}`;
        
        document.getElementById('day-selection-group').addEventListener('change', updateTimeInputs);
        
        updateTimeInputs();
        
        updateLockState(true);
    });

    // ----------------------------------------------------
    // [UI 로직] 정보 아이콘 클릭 토글
    // ----------------------------------------------------
    window.toggleTooltip = (event) => {
        const tooltip = document.getElementById('lock-info-tooltip');
        tooltip.classList.toggle('visible');
        event.stopPropagation();
    };

    // 툴팁 외부 클릭 시 툴팁 닫기
    document.addEventListener('click', (event) => {
        const tooltip = document.getElementById('lock-info-tooltip');
        const icon = document.getElementById('lock-info-icon');
        
        if (tooltip && !tooltip.contains(event.target) && !icon.contains(event.target)) {
            tooltip.classList.remove('visible');
        }
    });

    // ----------------------------------------------------
    // [UI/보호 로직] 잠금 상태 토글
    // ----------------------------------------------------
    let isLocked = true;

    const updateLockState = (locked) => {
        isLocked = locked;
        const generateButton = document.getElementById('generate-schedule');
        const lockButton = document.getElementById('lock-toggle');

        if (isLocked) {
            generateButton.disabled = true;
            lockButton.textContent = '🔒 잠금 해제';
            lockButton.classList.remove('unlocked');
        } else {
            generateButton.disabled = false;
            lockButton.textContent = '🔓 잠금 설정';
            lockButton.classList.add('unlocked');
        }
    };

    window.toggleLock = () => {
        if (isLocked) {
            const confirmUnlock = confirm("🚨 현재 테이블의 내용이 덮어씌워질 수 있습니다. 정말로 잠금을 해제하시겠습니까? (취소 시 잠금 유지)");
            if (confirmUnlock) {
                updateLockState(false);
            }
        } else {
            updateLockState(true);
        }
    };

    // ----------------------------------------------------
    // [UI 로직] 요일 체크박스 상태에 따라 시간 입력 필드를 동적으로 생성/제거
    // ----------------------------------------------------
    const updateTimeInputs = () => {
        const timeInputContainer = document.getElementById('day-time-inputs');
        const checkboxes = document.querySelectorAll('#day-selection-group input[type="checkbox"]');
        
        const currentTimeMap = {};
        timeInputContainer.querySelectorAll('input[type="time"]').forEach(input => {
            const dayIndex = parseInt(input.dataset.day);
            const timeType = input.dataset.type;
            if (!currentTimeMap[dayIndex]) currentTimeMap[dayIndex] = {};
            currentTimeMap[dayIndex][timeType] = input.value;
        });

        timeInputContainer.innerHTML = ''; 

        checkboxes.forEach(checkbox => {
            const dayIndex = parseInt(checkbox.value);
            const dayName = dayNamesKo[dayIndex];
            
            if (checkbox.checked) {
                const existingStart = currentTimeMap[dayIndex]?.start || '10:00';
                const existingEnd = currentTimeMap[dayIndex]?.end || '13:00';
                
                const row = document.createElement('div');
                row.classList.add('time-input-row');
                row.innerHTML = `
                    <label>(${dayName})요일:</label>
                    <div class="time-fields">
                        <input type="time" data-day="${dayIndex}" data-type="start" value="${existingStart}" required step="600">
                        <span>-</span>
                        <input type="time" data-day="${dayIndex}" data-type="end" value="${existingEnd}" required step="600">
                    </div>
                `;
                timeInputContainer.appendChild(row);
            }
        });

        if (timeInputContainer.children.length === 0) {
            timeInputContainer.innerHTML = '<p style="margin: 0; color: #777;">수업 요일을 1개 이상 선택해주세요.</p>';
        }
    };


    // ----------------------------------------------------
    // [A] 핵심 기능: 일정 생성 로직
    // ----------------------------------------------------
    window.generateSchedule = () => {
        if (isLocked) return; 
        
        const totalClasses = parseInt(document.getElementById('total-classes').value);
        const startDateStr = document.getElementById('start-date').value;
        
        const selectedCheckboxes = document.querySelectorAll('#day-selection-group input[type="checkbox"]:checked');
        const targetDays = Array.from(selectedCheckboxes)
            .map(cb => parseInt(cb.value))
            .sort((a, b) => a - b);

        const timeMap = {};
        let missingTime = false;
        
        document.querySelectorAll('#day-time-inputs input[type="time"]').forEach(input => {
            const dayIndex = parseInt(input.dataset.day);
            const timeType = input.dataset.type;
            const timeValue = input.value.trim();

            if (!timeMap[dayIndex]) timeMap[dayIndex] = {};

            timeMap[dayIndex][timeType] = timeValue;

            if (!timeValue) missingTime = true;
        });
        
        const finalTimeMap = {};
        for (const dayIndex in timeMap) {
            finalTimeMap[dayIndex] = `${timeMap[dayIndex].start} - ${timeMap[dayIndex].end}`;
        }


        // --- 유효성 검사 ---
        if (!startDateStr || isNaN(totalClasses) || totalClasses <= 0) {
            alert("총 회차 수와 수업 시작일을 정확히 입력해주세요.");
            return;
        }
        if (targetDays.length === 0) {
             alert("수업 요일을 1개 이상 선택해주세요.");
            return;
        }
        if (missingTime) {
            alert("선택된 모든 요일의 시작 시간과 종료 시간을 설정해주세요.");
            return;
        }
        // ------------------

        const initialDate = new Date(startDateStr);
        let currentDate = new Date(initialDate);
        let classCount = 0;
        const newRows = [];
        let dayIndex = 0;

        while (classCount < totalClasses) {
            
            const day = currentDate.getDay(); // 0(일) ~ 6(토)
            
            if (currentDate >= initialDate && targetDays.includes(day)) {
                
                const nextTargetDayInSequence = targetDays[dayIndex];
                
                if (day === nextTargetDayInSequence) {
                    
                    const classTime = finalTimeMap[day];
                    
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const date = String(currentDate.getDate()).padStart(2, '0');
                    const dateDisplay = `${year}.${month}.${date}`; 
                    
                    const dayOfWeek = getDayOfWeek(currentDate.toISOString().substring(0, 10));
                    
                    classCount++;
                    
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-date', dateDisplay); 
                    newRow.classList.add(`day-${day}`); // 요일 클래스 (tr)
                    newRow.innerHTML = `
                        <td>${String(classCount).padStart(2, '0')}</td>
                        <td class="editable-content date-cell day-${day}" data-col="date">${dateDisplay}</td>
                        <td data-col="day" class="day-${day}">${dayOfWeek}</td> 
                        <td class="editable-content day-${day}" data-col="time">${classTime}</td>
                    `;
                    newRows.push(newRow);

                    dayIndex = (dayIndex + 1) % targetDays.length;
                }
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }

        tableBody.innerHTML = '';
        newRows.forEach(row => tableBody.appendChild(row));
        
        updateLockState(true);
        sortTable(); 
    };
    
    // ----------------------------------------------------
    // [B] 테이블 편집/정렬/갱신 로직 (요일 클래스 업데이트 포함)
    // ----------------------------------------------------
    
    const parseDate = (dateStr) => {
        const parts = dateStr.split('.');
        if (parts.length === 3) { return new Date(`${parts[0]}-${parts[1]}-${parts[2]}`); }
        if (parts.length === 2) { return new Date(`${currentYear}-${parts[0]}-${parts[1]}`); }
        return null;
    };

    const formatDateForInput = (dateStr) => {
        const parts = dateStr.split('.');
        if (parts.length === 3) { return `${parts[0]}-${parts[1]}-${parts[2]}`; }
        return '';
    };

    const formatDateForDisplay = (dateInput) => {
        const parts = dateInput.split('-');
        if (parts.length === 3) { return `${parts[0]}.${parts[1]}.${parts[2]}`; }
        return dateInput;
    };

    const getDayOfWeek = (dateInput) => {
        let dateObj;
        if (typeof dateInput === 'string') {
            dateObj = new Date(dateInput);
        } else {
            dateObj = dateObj;
        }

        const days = ['(일)', '(월)', '(화)', '(수)', '(목)', '(금)', '(토)'];
        if (isNaN(dateObj)) return ''; 
        return days[dateObj.getDay()];
    };

    const sortTable = () => {
        const rows = Array.from(tableBody.querySelectorAll('tr:not(.month-header)'));
        
        rows.sort((a, b) => {
            const dateA = parseDate(a.getAttribute('data-date'));
            const dateB = parseDate(b.getAttribute('data-date'));
            return dateA - dateB;
        });

        tableBody.innerHTML = ''; 
        
        let currentYearMonth = null;
        let currentClassNo = 0; 
        
        rows.forEach(row => {
            const dateStr = row.getAttribute('data-date');
            const dateObj = parseDate(dateStr);
            
            if (!dateObj) return;

            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            const yearMonth = `${year}-${month}`;

            if (currentYearMonth !== yearMonth) {
                currentYearMonth = yearMonth;
                
                const header = document.createElement('tr');
                header.classList.add('month-header');
                header.innerHTML = `<td colspan="4">🗓️ ${year}년 ${month}월</td>`;
                tableBody.appendChild(header);
            }

            currentClassNo++;
            row.querySelector('td:first-child').textContent = String(currentClassNo).padStart(2, '0');

            tableBody.appendChild(row);
        });
    };

    const saveContent = (inputElement) => {
        const parentCell = inputElement.closest('td');
        const row = parentCell.closest('tr');
        let newContent = inputElement.value.trim();

        if (parentCell.classList.contains('date-cell')) {
            const dateDisplay = formatDateForDisplay(newContent);
            const dayOfWeek = getDayOfWeek(newContent);
            
            // 변경된 날짜의 요일 인덱스 (0~6) 계산
            const newDateObj = new Date(newContent);
            const dayIndex = newDateObj.getDay();

            // 기존 요일 클래스 제거 후 새 요일 클래스 추가
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                cell.classList.remove('day-0', 'day-6', 'day-1', 'day-2', 'day-3', 'day-4', 'day-5');
                cell.classList.add(`day-${dayIndex}`);
            });
            row.classList.remove('day-0', 'day-6', 'day-1', 'day-2', 'day-3', 'day-4', 'day-5');
            row.classList.add(`day-${dayIndex}`);
            
            parentCell.innerHTML = dateDisplay;
            row.setAttribute('data-date', dateDisplay); 
            
            const dayCell = row.cells[2];
            dayCell.innerHTML = dayOfWeek;

            sortTable();
        } else {
            parentCell.innerHTML = newContent;
        }

        parentCell.classList.remove('editable-cell', 'date-input-field');
        currentEditingCell = null;
    };

    tableBody.addEventListener('click', (event) => {
        const cell = event.target.closest('.editable-content');
        
        if (!cell || cell.querySelector('input')) return;
        
        if (currentEditingCell) saveContent(currentEditingCell.querySelector('input'));

        const originalContent = cell.innerHTML.trim();
        cell.classList.add('editable-cell'); 
        
        let inputHTML;
        if (cell.classList.contains('date-cell')) {
            const dateValue = formatDateForInput(originalContent);
            inputHTML = `<input type="date" value="${dateValue}" />`;
            cell.classList.add('date-input-field'); 
        } else {
            const isTimeCell = cell.getAttribute('data-col') === 'time';
            // 시간 셀을 위한 입력 필드에 10분 단위 step을 적용합니다. (600초)
            const stepAttr = isTimeCell ? ' step="600"' : ''; 
            
            // 입력창의 타입은 텍스트로 유지하여 사용자가 직접 입력하는 유연성을 확보했습니다.
            // 다만, 일부 모바일 환경에서는 input type="time"이 강제될 수 있습니다.
            inputHTML = `<input type="text" value="${originalContent.replace(/"/g, '&quot;')}" ${stepAttr} />`;
        }

        cell.innerHTML = inputHTML;
        const input = cell.querySelector('input');
        input.focus();
        currentEditingCell = cell;

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                saveContent(input);
                input.blur();
            }
        });
        input.addEventListener('blur', () => saveContent(input));
    });

    document.addEventListener('keydown', (event) => {
        if (currentEditingCell && event.key === 'Delete') {
            const rowToDelete = currentEditingCell.closest('tr');
            const 회차번호 = rowToDelete.querySelector('td').textContent;
            
            if (confirm(`정말로 회차 ${회차번호}을(를) 삭제하시겠습니까?`)) {
                rowToDelete.remove();
                currentEditingCell = null; 
                sortTable(); 
                event.preventDefault(); 
            }
        }
    });
</script>
</body>
</html>